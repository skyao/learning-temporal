---
title: "è½»æ¾å®žçŽ°Sagaæ¨¡å¼"
linkTitle: "è½»æ¾å®žçŽ°Sagaæ¨¡å¼"
weight: 10
date: 2021-01-29
description: >
  è½»æ¾å®žçŽ°Sagaæ¨¡å¼
---



https://temporal.io/blog/saga-pattern-made-easy

### ä½¿ç”¨ saga è¿›è¡Œæ—…è¡Œè§„åˆ’ï¼Œä½†ä¸å¸¦è¡ŒæŽ

ä¸Šæ¬¡ä½ å®¶äººåŽ»å½“åœ°å…¬å›­çŽ©æ—¶ï¼Œæ¯ä¸ªäººéƒ½åœ¨è°ˆè®º saga è®¾è®¡æ¨¡å¼ï¼ŒçŽ°åœ¨ä½ æƒ³çŸ¥é“å®ƒæ˜¯ä»€ä¹ˆï¼Œä½ æ˜¯å¦åº”è¯¥å°†å®ƒä½œä¸ºè‡ªå·±åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„ä¸€éƒ¨åˆ†ï¼Œä»¥åŠå¦‚ä½•å®žçŽ°å®ƒã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œè½¯ä»¶è®¾è®¡æ˜¯ä¸€ç§æ—¶å°šè¶‹åŠ¿ ã€‚

### Sagaçš„ç†ç”±

å¦‚æžœä½ æƒ³çŸ¥é“ saga æ¨¡å¼æ˜¯å¦é€‚åˆä½ çš„åº”ç”¨åœºæ™¯ï¼Œè¯·æ‰ªå¿ƒè‡ªé—®ï¼šä½ çš„é€»è¾‘æ˜¯å¦æ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œå…¶ä¸­ä¸€äº›æ­¥éª¤è·¨è¶Š**æœºå™¨ã€æœåŠ¡ã€åˆ†ç‰‡æˆ–æ•°æ®åº“**ï¼Œè€Œéƒ¨åˆ†æ‰§è¡Œæ˜¯ä¸å¯å–çš„ï¼Ÿäº‹å®žè¯æ˜Žï¼Œè¿™æ­£æ˜¯ saga çš„ç”¨æ­¦ä¹‹åœ°ã€‚ä¹Ÿè®¸æ‚¨æ­£åœ¨æ£€æŸ¥åº“å­˜ï¼Œå‘ç”¨æˆ·çš„ä¿¡ç”¨å¡æ”¶è´¹ï¼Œç„¶åŽå®Œæˆè®¢å•ã€‚ä¹Ÿè®¸ä½ æ­£åœ¨ç®¡ç†ä¾›åº”é“¾ã€‚Saga æ¨¡å¼ä¹‹æ‰€ä»¥æœ‰ç”¨ï¼Œæ˜¯å› ä¸ºå®ƒåŸºæœ¬ä¸Šå°±åƒä¸€å°çŠ¶æ€æœºï¼Œå¯ä»¥å­˜å‚¨ç¨‹åºè¿›åº¦ã€é˜²æ­¢ä¿¡ç”¨å¡å¤šæ¬¡åˆ·å¡ã€åœ¨å¿…è¦æ—¶è¿›è¡Œè¿˜åŽŸï¼Œå¹¶æ¸…æ¥šåœ°çŸ¥é“åœ¨æ–­ç”µçš„æƒ…å†µä¸‹å¦‚ä½•å®‰å…¨åœ°æ¢å¤åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚

ç”¨æ¥è§£é‡Š saga æ¨¡å¼å¦‚ä½•å¼¥è¡¥å¤±è´¥çš„å¸¸è§ç”Ÿæ´»å®žä¾‹æ˜¯æ—…è¡Œè®¡åˆ’ã€‚å‡è®¾ä½ å¾ˆæƒ³åŽ»è¥¿é›…å›¾çš„æœç“¦ç±³ä»€åœ°åŒºæ·‹é›¨ã€‚ä½ éœ€è¦è´­ä¹°æœºç¥¨ã€é¢„è®¢é…’åº—ï¼Œå¹¶èŽ·å¾—ä¸€å¼ é›·å°¼å°”å±±èƒŒåŒ…æ—…è¡Œçš„é—¨ç¥¨ã€‚è¿™ä¸‰ä»¶äº‹éƒ½æ˜¯ä¸€çŽ¯æ‰£ä¸€çŽ¯çš„ï¼šå¦‚æžœæ‚¨ä¹°ä¸åˆ°æœºç¥¨ï¼Œå°±æ²¡æœ‰ç†ç”±åŽ»ä¹°å…¶ä»–çš„ç¥¨ã€‚å¦‚æžœä½ ä¹°åˆ°äº†æœºç¥¨å´æ²¡åœ°æ–¹ä½ï¼Œä½ å°±ä¼šæƒ³å–æ¶ˆæœºç¥¨é¢„è®¢ï¼ˆæˆ–é‡æ–°é¢„è®¢é…’åº—æˆ–æ‰¾å…¶ä»–åœ°æ–¹ä½ï¼‰ã€‚æœ€åŽï¼Œå¦‚æžœä½ è®¢ä¸åˆ°èƒŒåŒ…æ—…è¡Œçš„é—¨ç¥¨ï¼Œé‚£å°±çœŸçš„æ²¡æœ‰å…¶ä»–ç†ç”±æ¥è¥¿é›…å›¾äº†ï¼Œæ‰€ä»¥è¿˜ä¸å¦‚å–æ¶ˆæ•´ä¸ªæ—…è¡Œã€‚(å¼€çŽ©ç¬‘ï¼‰

![](images/sagas_vs_workflows__-_Algorithm_flowchart_example__1_.svg)

ä¸Šå›¾ï¼šä¸€ä¸ªé¢å¯¹æ—…è¡Œè®¡åˆ’å¤±è´¥è¿›è¡Œè¡¥å¿çš„ç®€å•æ¨¡åž‹

çŽ°å®žä¸–ç•Œä¸­æœ‰å¾ˆå¤š "è¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆä¸åš" çš„è½¯ä»¶åº”ç”¨ï¼šå¦‚æžœä½ æˆåŠŸåœ°å‘ç”¨æˆ·æ”¶å–äº†å•†å“è´¹ç”¨ï¼Œä½†ä½ çš„å±¥è¡ŒæœåŠ¡å´æŠ¥å‘Šå•†å“ç¼ºè´§ï¼Œå¦‚æžœä½ ä¸é€€è¿˜è´¹ç”¨ï¼Œç”¨æˆ·å°±ä¼šä¸é«˜å…´ã€‚å¦‚æžœä½ é‡åˆ°äº†ç›¸åçš„é—®é¢˜ï¼Œä¸å°å¿ƒ "å…è´¹" äº¤ä»˜äº†å•†å“ï¼Œä½ å°±ä¼šè¢«æ·˜æ±°å‡ºå±€ã€‚å¦‚æžœåè°ƒæœºå™¨å­¦ä¹ æ•°æ®å¤„ç†æµæ°´çº¿çš„æœºå™¨å´©æºƒäº†ï¼Œä½†åŽç»­æœºå™¨ä»åœ¨ç»§ç»­å¤„ç†æ•°æ®ï¼Œè€Œå®ƒä»¬çš„æ•°æ®å´æ— å¤„ä¸ŠæŠ¥ï¼Œé‚£ä¹ˆä½ å¯èƒ½ä¼šé¢ä¸´ä¸€ç¬”éžå¸¸æ˜‚è´µçš„è®¡ç®—èµ„æºè´¦å•ã€‚ åœ¨æ‰€æœ‰è¿™äº›æƒ…å†µä¸‹ï¼ŒSaga æ¨¡å¼éƒ½æä¾›äº†æŸç§ "è¿›åº¦è·Ÿè¸ª" å’Œè¡¥å¿ä»£ç ï¼Œä»¥å¤„ç†è¿™äº› "è¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åš" çš„ä»»åŠ¡ã€‚åœ¨ Saga æœ¯è¯­ä¸­ï¼Œè¿™ç±» "è¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åš" çš„ä»»åŠ¡è¢«ç§°ä¸ºé•¿æœŸäº‹åŠ¡ã€‚è¿™å¹¶ä¸ä¸€å®šæ„å‘³ç€è¿™ç±»äº‹åŠ¡è¦è¿è¡Œ "å¾ˆé•¿æ—¶é—´"ï¼Œåªæ˜¯ä¸Žæœ¬åœ°è¿è¡Œçš„ã€ä¸Žå•ä¸ªæ•°æ®åº“äº¤äº’çš„äº‹åŠ¡ç›¸æ¯”ï¼Œå®ƒä»¬åœ¨é€»è¾‘æ—¶é—´ä¸Šéœ€è¦æ›´å¤šçš„æ­¥éª¤ã€‚

### å¦‚ä½•åˆ›ä½œ sagaï¼Ÿ

Saga ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

1. ä¸º "å€’é€€" è€Œå®šä¹‰çš„è¡Œä¸ºï¼Œå¦‚æžœä½ éœ€è¦ "æ’¤é”€" æŸäº›äº‹æƒ…ï¼ˆå³è¡¥å¿ï¼‰
2. åŠªåŠ›å‘å‰è¿ˆè¿›çš„è¡Œä¸ºï¼ˆå³ä¿å­˜çŠ¶æ€ï¼Œä»¥ä¾¿åœ¨å¤±è´¥æ—¶çŸ¥é“ä»Žå“ªé‡Œæ¢å¤ï¼‰

æœ¬åšå®¢çš„å¿ å®žè¯»è€…ä¸€å®šè¿˜è®°å¾—æˆ‘æœ€è¿‘å†™è¿‡ä¸€ç¯‡å…³äºŽè¡¥å¿è¡Œä¸ºçš„æ–‡ç« ã€‚ä»Žä¸Šæ–‡å¯ä»¥çœ‹å‡ºï¼Œè¡¥å¿åªæ˜¯ saga è®¾è®¡æ¨¡å¼çš„ä¸€åŠã€‚ä¸Šæ–‡æåˆ°çš„å¦ä¸€åŠæœ¬è´¨ä¸Šæ˜¯æ•´ä¸ªç³»ç»Ÿçš„çŠ¶æ€ç®¡ç†ã€‚è¡¥å¿åŠ¨ä½œæ¨¡å¼å¯ä»¥å¸®åŠ©ä½ äº†è§£åœ¨å•ä¸ªæ­¥éª¤ï¼ˆæˆ–è€…ç”¨ temporal æœ¯è¯­æ¥è¯´ï¼Œä¸€ä¸ªæ´»åŠ¨/activityï¼‰å¤±è´¥æ—¶å¦‚ä½•æ¢å¤ã€‚ä½†å¦‚æžœæ•´ä¸ªç³»ç»Ÿç˜«ç—ªäº†å‘¢ï¼Ÿä»Žå“ªé‡Œå¼€å§‹æ¢å¤ï¼Ÿå› ä¸ºå¹¶ä¸æ˜¯æ¯ä¸ªæ­¥éª¤éƒ½é™„å¸¦æœ‰è¡¥å¿ï¼Œæ‰€ä»¥ä½ åªèƒ½æ ¹æ®å­˜å‚¨çš„è¡¥å¿è¿›è¡Œæœ€ä½³çŒœæµ‹ã€‚Saga æ¨¡å¼ä¼šè®°å½•ä½ å½“å‰æ‰€å¤„çš„ä½ç½®ï¼Œè¿™æ ·ä½ å°±å¯ä»¥ç»§ç»­å‘å‰è¿ˆè¿›ã€‚

### é‚£ä¹ˆï¼Œå¦‚ä½•åœ¨è‡ªå·±çš„ä»£ç ä¸­å®žçŽ°sagaå‘¢ï¼Ÿ

å¾ˆé«˜å…´ä½ è¿™ä¹ˆé—®ã€‚

å‘å‰å€¾

åœ¨è€³è¾¹ä½Žè¯­

è¿™æ˜¯ä¸ªæœ‰ç‚¹å°æŠ€å·§çš„é—®é¢˜ï¼Œå› ä¸ºä½¿ç”¨ Temporal è¿è¡Œä»£ç æ—¶ï¼Œä½ ä¼šè‡ªåŠ¨ä¿å­˜çŠ¶æ€ï¼Œå¹¶åœ¨ä»»ä½•çº§åˆ«å¤±è´¥æ—¶é‡è¯•ã€‚è¿™å°±æ„å‘³ç€ï¼Œä½¿ç”¨ Temporal çš„ saga æ¨¡å¼éžå¸¸ç®€å•ï¼Œåªéœ€åœ¨æŸä¸ªæ­¥éª¤ï¼ˆæ´»åŠ¨ï¼‰å¤±è´¥æ—¶ç¼–å†™ä½ å¸Œæœ›é‡‡å–çš„è¡¥å¿æŽªæ–½å³å¯ã€‚æžå®šã€‚

è¿™ç§é­”åŠ›èƒŒåŽçš„_åŽŸå› _æ˜¯ Temporal åœ¨è®¾è®¡ä¸Šè‡ªåŠ¨è·Ÿè¸ªç¨‹åºçš„è¿›åº¦ï¼Œå¹¶èƒ½åœ¨å‘ç”Ÿç¾éš¾æ€§æ•…éšœæ—¶ä»Žä¸­æ–­çš„åœ°æ–¹é‡æ–°å¼€å§‹ã€‚æ­¤å¤–ï¼ŒTemporal è¿˜ä¼šåœ¨æ´»åŠ¨å¤±è´¥æ—¶é‡è¯•ï¼Œé™¤äº†æŒ‡å®šé‡è¯•ç­–ç•¥å¤–ï¼Œä½ ä¸éœ€è¦æ·»åŠ ä»»ä½•ä»£ç ï¼Œä¾‹å¦‚ï¼š

```java
RetryOptions retryoptions = RetryOptions.newBuilder()
       .setInitialInterval(Duration.ofSeconds(1))
       .setMaximumInterval(Duration.ofSeconds(100))
       .setBackoffCoefficient(2)
       .setMaximumAttempts(500).build();
```

è¦è¿›ä¸€æ­¥äº†è§£è¿™ç§è‡ªåŠ¨æœºåˆ¶æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè¯·ç»§ç»­å…³æ³¨æˆ‘å³å°†å‘è¡¨çš„å…³äºŽç¼–æŽ’å’Œåè°ƒï¼ˆå®žçŽ° saga çš„ä¸¤ç§å¸¸ç”¨æ–¹æ³•ï¼‰çš„æ–‡ç« ã€‚

å› æ­¤ï¼Œè¦è¡¨è¾¾æˆ‘çš„ç¨‹åºçš„é«˜å±‚é€»è¾‘ï¼ŒåŒ…æ‹¬é¢„è®¢å‡æœŸçš„æ­¥éª¤ä»¥åŠæˆ‘å¸Œæœ›åœ¨å¤±è´¥æ—¶é‡‡å–çš„è¡¥å¿æŽªæ–½ï¼Œå®ƒçœ‹èµ·æ¥å°±åƒä¸‹é¢çš„ä¼ªä»£ç ï¼š

```java
try:
   registerCompensationInCaseOfFailure(cancelHotel)
   bookHotel
   registerCompensationInCaseOfFailure(cancelFlight)
   bookFlight
   registerCompensationInCaseOfFailure(cancelExcursion)
   bookExcursion
catch:
   run all compensation activities
```

åœ¨ Java ä¸­ï¼ŒSaga ç±»ä¼šä¸ºæ‚¨è®°å½•è¡¥å¿ä¿¡æ¯ï¼š

```java
@Override
public void bookVacation(BookingInfo info) {
   Saga saga = new Saga(new Saga.Options.Builder().build());
   try {
       saga.addCompensation(activities::cancelHotel, info.getClientId());
       activities.bookHotel(info);

       saga.addCompensation(activities::cancelFlight, info.getClientId());
       activities.bookFlight(info);

       saga.addCompensation(activities::cancelExcursion, 
                            info.getClientId());
       activities.bookExcursion(info);
   } catch (TemporalFailure e) {
       saga.compensate();
       throw e;
   }
}
```

åœ¨å…¶ä»–è¯­è¨€çš„ SDK ä¸­ï¼Œæ‚¨å¯ä»¥è‡ªå·±è½»æ¾ç¼–å†™ addCompensation å’Œ compensate å‡½æ•°ã€‚ä¸‹é¢æ˜¯ Go è¯­è¨€çš„ä¸€ä¸ªç‰ˆæœ¬ï¼š

```go
func (s *Compensations) AddCompensation(activity any, parameters ...any) {
	s.compensations = append(s.compensations, activity)
	s.arguments = append(s.arguments, parameters)
}

func (s Compensations) Compensate(ctx workflow.Context, inParallel bool) {
	if !inParallel {
		// Compensate in Last-In-First-Out order, to undo in the reverse order that activies were applied.
		for i := len(s.compensations) - 1; i >= 0; i-- {
			errCompensation := workflow.ExecuteActivity(ctx, s.compensations[i], s.arguments[i]...).Get(ctx, nil)
			if errCompensation != nil {
				workflow.GetLogger(ctx).Error("Executing compensation failed", "Error", errCompensation)
			}
		}
	} else {
		selector := workflow.NewSelector(ctx)
		for i := 0; i < len(s.compensations); i++ {
			execution := workflow.ExecuteActivity(ctx, s.compensations[i], s.arguments[i]...)
			selector.AddFuture(execution, func(f workflow.Future) {
				if errCompensation := f.Get(ctx, nil); errCompensation != nil {
					workflow.GetLogger(ctx).Error("Executing compensation failed", "Error", errCompensation)
				}
			})
		}
		for range s.compensations {
			selector.Select(ctx)
		}
	}
}
```

æ­¥éª¤å’Œè¡¥å¿çš„é«˜çº§ Go ä»£ç ä¸Ž Java ç‰ˆæœ¬éžå¸¸ç›¸ä¼¼ï¼š

```go
func TripPlanningWorkflow(ctx workflow.Context, info BookingInfo) (err error) {
   options := workflow.ActivityOptions{
       StartToCloseTimeout: time.Second * 5,
       RetryPolicy:         &temporal.RetryPolicy{MaximumAttempts: 2},
   }

   ctx = workflow.WithActivityOptions(ctx, options)

   var compensations Compensations

   defer func() {
       if err != nil {
           // activity failed, and workflow context is canceled
           disconnectedCtx, _ := workflow.NewDisconnectedContext(ctx)
           compensations.Compensate(disconnectedCtx, true)
       }
   }()

   compensations.AddCompensation(CancelHotel)
   err = workflow.ExecuteActivity(ctx, BookHotel, info).Get(ctx, nil)
   if err != nil {
       return err
   }

   compensations.AddCompensation(CancelFlight)
   err = workflow.ExecuteActivity(ctx, BookFlight, info).Get(ctx, nil)
   if err != nil {
       return err
   }

   compensations.AddCompensation(CancelExcursion)
   err = workflow.ExecuteActivity(ctx, BookExcursion, info).Get(ctx, nil)
   if err != nil {
       return err
   }

   return err
}
```

ä¸Šè¿°é«˜çº§ä»£ç åºåˆ—è¢«ç§°ä¸º temporal å·¥ä½œæµã€‚è€Œä¸”ï¼Œå¦‚å‰æ‰€è¿°ï¼Œé€šè¿‡ä½¿ç”¨ Temporal è¿è¡Œï¼Œæˆ‘ä»¬ä¸å¿…æ‹…å¿ƒé€šè¿‡äº‹ä»¶æºæˆ–æ·»åŠ é‡è¯•å’Œé‡å¯é€»è¾‘æ¥å®žçŽ°ä»»ä½•è·Ÿè¸ªè¿›åº¦çš„ bookkeeping åŠŸèƒ½ï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯å…è´¹æä¾›çš„ã€‚å› æ­¤ï¼Œåœ¨ç¼–å†™ä½¿ç”¨ Temporal è¿è¡Œçš„ä»£ç æ—¶ï¼Œä½ åªéœ€æ‹…å¿ƒå¦‚ä½•ç¼–å†™è¡¥å¿ï¼Œå…¶ä½™çš„éƒ½æ˜¯å…è´¹æä¾›çš„ã€‚

### å¹‚ç­‰

å¥½å§ï¼Œè¿˜æœ‰ç¬¬äºŒä»¶äº‹éœ€è¦ "æ‹…å¿ƒ"ã€‚ä½ å¯èƒ½è¿˜è®°å¾—ï¼Œsaga ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯æˆ‘ä»¬ä¹‹å‰ç¼–ç çš„è¡¥å¿ã€‚ç¬¬äºŒéƒ¨åˆ†æ˜¯ "åŠªåŠ›å‘å‰æŽ¨è¿›"ï¼ŒåŒ…æ‹¬é¢å¯¹å¤±è´¥æ—¶å¯èƒ½é‡æ–°å°è¯•æŸé¡¹æ´»åŠ¨ã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£å…¶ä¸­ä¸€ä¸ªæ­¥éª¤ï¼Œå¥½å—ï¼ŸTemporal æ‰¿æ‹…äº†é‡è¯•å’Œè·Ÿè¸ªæ•´ä½“è¿›åº¦çš„æ‰€æœ‰é‡ä»»ï¼Œä½†ç”±äºŽä»£ç å¯ä»¥é‡è¯•ï¼Œç¨‹åºå‘˜éœ€è¦ç¡®ä¿æ¯ä¸ª Temporal æ´»åŠ¨éƒ½æ˜¯å¹‚ç­‰çš„ã€‚è¿™æ„å‘³ç€æ— è®ºè°ƒç”¨ä¸€æ¬¡è¿˜æ˜¯å¤šæ¬¡ï¼Œè§‚å¯Ÿåˆ°çš„ bookFlight ç»“æžœéƒ½æ˜¯ä¸€æ ·çš„ã€‚è¯´å¾—å…·ä½“ä¸€ç‚¹ï¼Œè®¾ç½®æŸä¸ªå­—æ®µ foo=3 çš„å‡½æ•°æ˜¯å¹‚ç­‰çš„ï¼Œå› ä¸ºæ— è®ºè°ƒç”¨å¤šå°‘æ¬¡ï¼Œä¹‹åŽ foo éƒ½æ˜¯ 3ã€‚å‡½æ•° foo += 3 ä¸æ˜¯å¹‚ç­‰çš„ï¼Œå› ä¸º foo çš„å€¼å–å†³äºŽå‡½æ•°è¢«è°ƒç”¨çš„æ¬¡æ•°ã€‚éžå¹‚ç­‰æ€§æœ‰æ—¶çœ‹èµ·æ¥æ›´å¾®å¦™ï¼šå¦‚æžœæ•°æ®åº“å…è®¸é‡å¤è®°å½•ï¼Œé‚£ä¹ˆè°ƒç”¨ INSERT INTO foo (bar) VALUES (3) çš„å‡½æ•°ä¼šè½»çŽ‡åœ°åœ¨è¡¨ä¸­åˆ›å»ºä¸Žè°ƒç”¨æ¬¡æ•°ç›¸åŒçš„è®°å½•ï¼Œå› æ­¤ä¸æ˜¯å¹‚ç­‰çš„ã€‚å‘é€ç”µå­é‚®ä»¶æˆ–è½¬è´¦çš„å‡½æ•°çš„å¤©ç„¶å®žçŽ°ä¹Ÿä¸æ˜¯é»˜è®¤å¹‚ç­‰ã€‚

å¦‚æžœä½ æ­£åœ¨æ…¢æ…¢é€€ç¼©ï¼Œå› ä¸ºä½ çš„çœŸå®žä¸–ç•Œåº”ç”¨ç¨‹åºè¦åšçš„äº‹æƒ…æ¯” set foo=3 å¤æ‚å¾—å¤šï¼Œé‚£ä¹ˆè¯·æŒ¯ä½œèµ·æ¥ã€‚æœ‰ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç‹¬ç‰¹çš„æ ‡è¯†ç¬¦ï¼ˆç§°ä¸ºidempotency keyï¼Œæœ‰æ—¶ä¹Ÿç§°ä¸º referenceId æˆ–ç±»ä¼¼æ ‡è¯†ç¬¦ï¼‰æ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªç‰¹å®šçš„äº‹åŠ¡ï¼Œå¹¶ç¡®ä¿é…’åº—é¢„è®¢äº‹åŠ¡åªæœ‰æ•ˆå‘ç”Ÿä¸€æ¬¡ã€‚idempotency key çš„å®šä¹‰æ–¹å¼å¯æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€è¦è€Œå®šã€‚åœ¨æ—…è¡Œè®¡åˆ’åº”ç”¨ç¨‹åºä¸­ï¼ŒBookingInfo ä¸­çš„ä¸€ä¸ªå­—æ®µ clientId ç”¨äºŽå”¯ä¸€æ ‡è¯†äº‹åŠ¡ã€‚

```go
type BookingInfo struct {
   Name     string
   ClientId string
   Address  string
   CcInfo   CreditCardInfo
   Start    date.Date
   End      date.Date
}
```

åœ¨ä¸Šè¿° Java å·¥ä½œæµä»£ç ä¸­ï¼Œæ‚¨å¯èƒ½è¿˜çœ‹åˆ°äº†ç”¨äºŽæ³¨å†Œè¡¥å¿çš„ clientIdï¼š

```java
saga.addCompensation(activities::cancelHotel, info.getClientId());
```

ä¸è¿‡ï¼Œä½¿ç”¨ clientId ä½œä¸ºé”®å¯ä»¥é™åˆ¶æŸä¸ªäººåŒæ—¶é¢„è®¢å¤šä¸ªå‡æœŸã€‚è¿™å¯èƒ½æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚ä½†æ˜¯ï¼Œä¸€äº›ä¸šåŠ¡åº”ç”¨ç¨‹åºå¯èƒ½ä¼šé€‰æ‹©é€šè¿‡ç»“åˆå®¢æˆ· ID å’Œå·¥ä½œæµ ID æ¥å»ºç«‹ä¸€ä¸ªå”¯ä¸€å¯†é’¥ï¼Œä»¥å…è®¸æ¯ä¸ªå®¢æˆ·åŒæ—¶é¢„è®¢å¤šä¸ªå‡æœŸã€‚å¦‚æžœæ‚¨æƒ³è¦ä¸€ä¸ªçœŸæ­£å”¯ä¸€çš„å¹‚ç­‰ keyï¼Œæ‚¨å¯ä»¥å‘å·¥ä½œæµä¼ é€’ä¸€ä¸ª UUIDã€‚æ‚¨å¯ä»¥æ ¹æ®è‡ªå·±åº”ç”¨ç¨‹åºçš„éœ€è¦åšå‡ºé€‰æ‹©ã€‚

è®¸å¤šå¤„ç†èµ„é‡‘çš„ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºæŽ¥å£å·²ç»æŽ¥å—äº†ç”¨äºŽæ­¤ç›®çš„çš„å¹‚ç­‰é”®ã€‚å¦‚æžœéœ€è¦è‡ªå·±å®žçŽ°è¿™æ ·çš„åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨åŽŸå­å†™å…¥æ¥è®°å½•è¿„ä»Šä¸ºæ­¢å·²æŸ¥çœ‹è¿‡çš„å¹‚ç­‰é”®ï¼Œå¦‚æžœæŸä¸ªæ“ä½œçš„å¹‚ç­‰é”®åœ¨ "å·²æŸ¥çœ‹è¿‡" é›†åˆä¸­ï¼Œå°±ä¸è¦æ‰§è¡Œè¯¥æ“ä½œã€‚

### ä¼˜åŠ¿ä¸Žå¤æ‚æ€§

saga æ¨¡å¼ç¡®å®žä¼šå¢žåŠ ä»£ç çš„å¤æ‚æ€§ï¼Œå› æ­¤ä¸è¦å› ä¸ºæœ‰äº†å¾®æœåŠ¡å°±åœ¨ä»£ç ä¸­å®žçŽ°å®ƒï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚ä½†æ˜¯ï¼Œå¦‚æžœæ‚¨éœ€è¦å®Œæˆä¸€é¡¹æ¶‰åŠå¤šä¸ªæœåŠ¡çš„ä»»åŠ¡ï¼ˆå¦‚é¢„è®¢æœºç¥¨å’Œé…’åº—ï¼‰ï¼Œè€Œéƒ¨åˆ†æ‰§è¡Œå®žé™…ä¸Šå¹¶ä¸æˆåŠŸï¼Œé‚£ä¹ˆ saga å°†æ˜¯æ‚¨çš„æœ‹å‹ã€‚æ­¤å¤–ï¼Œå¦‚æžœä½ å‘çŽ°è‡ªå·±çš„ saga å˜å¾—ç‰¹åˆ«ç¬¨é‡ï¼Œå¯èƒ½å°±éœ€è¦é‡æ–°è€ƒè™‘å¦‚ä½•åˆ’åˆ†å¾®æœåŠ¡ï¼Œå¹¶å·èµ·è¢–å­è¿›è¡Œé‡æž„äº†ã€‚æ€»çš„æ¥è¯´ï¼ŒTemporal å¯ä»¥è®©ä½ åœ¨ä»£ç ä¸­å®žçŽ° saga æ¨¡å¼å˜å¾—ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºä½ åªéœ€ç¼–å†™æ¯ä¸€æ­¥æ‰€éœ€çš„è¡¥å¿å³å¯ã€‚æ•¬è¯·æœŸå¾…æˆ‘çš„ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†æ·±å…¥æŽ¢è®¨ saga å’Œè®¢é˜…åœºæ™¯ï¼ŒTemporal åœ¨é™ä½Ž saga å·¥ä½œçš„å¤æ‚æ€§æ–¹é¢å°¤ä¸ºçªå‡ºã€‚

ä½¿ç”¨æœ¬æ–‡æ‰€è¿°ä»£ç çš„å®Œæ•´ç‰ˆæœ¬åº“å¯åœ¨ GitHub ä¸Šæ‰¾åˆ°ï¼š

- [Java code](https://github.com/efortuna/sagas-temporal-trip-booking/tree/main/java)
- [Go code](https://github.com/efortuna/sagas-temporal-trip-booking/tree/main/go)

å¦‚æžœæ‚¨æƒ³äº†è§£å…¶ä»–ä½¿ç”¨ Temporal çš„ saga æ•™ç¨‹ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹èµ„æºï¼š

- [Java: Booking Saga](https://github.com/temporalio/samples-java/blob/main/src/main/java/io/temporal/samples/bookingsaga/README.md)
- [Go: Money Transfer Saga](https://github.com/temporalio/samples-go/tree/main/saga)
- [PHP: Money Transfer Saga](https://github.com/temporalio/samples-php/tree/master/app/src/Saga)
- [Python: Booking Saga](https://github.com/rachfop/temporal-sagas)
- [TypeScript: Money Transfer Saga](https://github.com/temporalio/samples-typescript/tree/main/saga)

æ­¤å¤–ï¼Œæˆ‘çš„ä¸€ä½åŒäº‹ Dominik Tornow è¿˜åœ¨ YouTube ä¸Šä»‹ç»äº† sagaã€‚

åœ¨æˆ‘ä»¬çš„è¯¾ç¨‹ã€æ•™ç¨‹ã€æ–‡æ¡£å’Œè§†é¢‘ä¸­äº†è§£æ›´å¤šæœ‰å…³ Temporal çš„ä¿¡æ¯ã€‚

### æ³¨é‡Š

1. æ˜¾ç„¶ï¼Œä¸è¦å› ä¸ºå®ƒæ˜¯æ–°çš„çƒ­ç‚¹å°±é‡æ–°è®¾è®¡ä½ çš„ç³»ç»Ÿã€‚é™¤éžå®ƒæ˜¯ä¸€ä¸ªæ–°çš„ JavaScript æ¡†æž¶ã€‚é‚£å°±èµ¶ç´§ç”¨ npm å®‰è£…é‚£ä¸ªæ–°è½¯ä»¶åŒ…å§ã€‚ðŸ˜œ
2. åˆ«æ‹…å¿ƒï¼Œsaga å¹¶ä¸æ˜¯ä¸€ç§è¶‹åŠ¿ï¼Œè‡ªä¸Šä¸–çºª 80 å¹´ä»£ä»¥æ¥ï¼Œsaga å°±ä¸€ç›´å­˜åœ¨äºŽæ•°æ®åº“ä¸­ã€‚æ‚¨å¯ä»¥æ”¾å¿ƒï¼Œå› ä¸ºæ‚¨çš„é¡¹ç›®è®¾è®¡ç»å…¸ä¼˜é›…ã€‚

3. è¿™å¹¶ä¸æ˜¯è¯´ä½œè€…å¯¹è¿™ç§æƒ…å†µå®Œå…¨æ²¡æœ‰ç»éªŒã€‚

4. é€»è¾‘æ—¶é—´æ˜¯åˆ†å¸ƒå¼è®¡ç®—ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œç”¨äºŽæè¿°åˆ†å¸ƒå¼è®¡ç®—ä¸­ä¸åŒæœºå™¨ä¸Šå‘ç”Ÿäº‹ä»¶çš„æ—¶é—´ï¼Œå› ä¸ºæœºå™¨å¯èƒ½æ²¡æœ‰ç‰©ç†åŒæ­¥çš„å…¨å±€æ—¶é’Ÿã€‚é€»è¾‘æ—¶é—´åªæ˜¯è¿™äº›æœºå™¨ä¸Šå‘ç”Ÿçš„äº‹ä»¶çš„å› æžœæŽ’åºã€‚å°±é•¿æœŸè¿è¡Œçš„äº‹åŠ¡è€Œè¨€ï¼Œå®ƒåŸºæœ¬ä¸Šå¯ä»¥å½’ç»“ä¸ºåœ¨ä¸åŒæœºå™¨ä¸Šå‘ç”Ÿçš„è®¸å¤š "æ­¥éª¤"ã€‚
